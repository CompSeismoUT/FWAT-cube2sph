#!/bin/bash
set -e 

# gcc 
F90="gfortran"
CXX="g++"

# intel 
# CXX="icc"
# F90="ifort"

# SAC HOME
SACHOME=${HOME}/software/sac/

### STOP HERE ##########

# check input dir
if [[ $# -ne 2 ]]; then 
  echo "Usage: ./INSTALL.sh SUBMIT_SYSTEM(slurm/pbs/local) INSTALL_DIR"
  exit 1
fi
SYSTEM=$1
INSTALL_DIR=$2

# compile measure_adj
mkdir -p build
cd build
cmake .. -DCXX=$CXX -DFC=$F90 -DSACHOME=${SACHOME} -DPYTHON_EXECUTABLE=`which python`
make install -j4 
cd ..
rm -rf build 

mkdir -p $INSTALL_DIR
\cp -r scripts/module_env scripts/*.sh plots fwat_params $INSTALL_DIR/
CDIR=`pwd`
awk -v val="$CDIR" '{if ($0 ~ /^FWATLIB_PATH=/) print "FWATLIB_PATH="val; else print $0}' $INSTALL_DIR/parameters.sh> tmp && mv tmp $INSTALL_DIR/parameters.sh

if [ "$SYSTEM" == "slurm" ]; then 
  \cp scripts/slurm/*.sh  $INSTALL_DIR/
elif [ "$SYSTEM" == "local" ]; then 
  \cp scripts/slurm/*.sh  $INSTALL_DIR/
  \cp scripts/local/*.sh $INSTALL_DIR/
else 
  echo "$SYSTEM is not implemented!"
  exit 1
fi 


chmod +x $INSTALL_DIR/*.sh 
chmod +x fwatlib/*.sh

echo " ============= " 
echo " Install Successfully!"
echo " ============= " 